<!doctype html>
<html>
  <head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="stylesheets/style.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Socket.io library  -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="container-fluid">
      <div class="topnav">
        <a class="active" href="#explore">Explore</a>
        <a href="#newRide" type="button" data-toggle="modal"
            data-target="#newRideModal">New Ride</a>
        <a href="#logout" type="button" data-toggle="modal"
            data-target="#logoutModal">Logout</a>
        <input type="text" placeholder="Search for a different ride..">
      </div>
      <h1>Destination: University of Calgary</h1>

      <!-- Modal -->
      <div id="newRideModal" class="modal fade" role="dialog">
        <div class="modal-dialog" id="post-ride-modal">

          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">Post A New Ride</h4>
            </div>
            <div class="modal-body container-fluid" id="post-ride-body">
              <div class="row">
                <div class="col-sm-4" id="ride-details">
                  <h2 id="details-header">Ride Details</h2>
                  <input class="controls" id="origin-input" placeholder="Enter an origin location"
                         type="text">

                  <input class="controls" id="destination-input" placeholder="Enter a destination location"
                         type="text">
                  <div class="selector-images" >
                    <img alt="Passenger" class="ride-selector" id="imgPassenger" onclick="switchSelectedRole(this.id)"
                         src="images/passenger.png">
                    <img alt="Driver" class="ride-selector" id="imgDriver" onclick="switchSelectedRole(this.id)" src="images/car.png">
                  </div>
                  <span class="ride-detail-element detail-span" id="group-size"> Group size: <input class="single-digit" maxlength="1"
                                                                                                    pattern="\d*" size="1"
                                                                                                    type="text"></span>
                  <div id="driver-form-elements">
                    <span class="ride-detail-element detail-span" id="departure-time"> Departure time: <input class="single-digit" type="time"></span>
                    <span class="ride-detail-element detail-span" id="capacity"> Capacity: <input class="single-digit" maxlength="1" pattern="\d*"
                                                                                                  size="1" type="text"></span>
                    <span class="ride-detail-element detail-span" id="price"> Price: <input class="single-digit" maxlength="6" pattern="\d*"
                                                                                            size="6" type="text"></span>
                  </div>

                  <button class="ride-detail-element search">Search</button>

                </div>
                <div class="col-sm-8" id="map"></div>
              </div>

              <div style="display: none">
                <div class="controls" id="mode-selector">
                  <input checked="checked" id="changemode-driving" name="type" type="radio">
                  <label for="changemode-driving">Driving</label>
                </div>
              </div>
            </div>

              <footer>
                <span>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com"
                                                                                            title="Flaticon">www.flaticon.com</a>&nbsp;</span>
                <div>Icon made by <a href="https://www.flaticon.com/authors/pixel-buddha" title="Pixel Buddha">Pixel Buddha</a> from
                  <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
              </footer>

              <script async
                      defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCj9Fanni2mPxM4cp3y1DAL1FqOfhY3M0M&libraries=places&callback=initMap"></script>
              <!-- Test Portion for Embedded Map -->
              <!--<iframe allowfullscreen frameborder="0" height="450" id='embeddedMap' src="" style="border:0" width="600"></iframe>-->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Post Ride</button>
            </div>
          </div>

        </div>
      </div>
      <!-- Modal -->
      <div id="logoutModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">Log Out Of Account</h4>
            </div>
            <div class="modal-body">
              <p>Are you sure you wish to log out?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Yes</button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Steve, 4 star</h3>
            <h3>Departure: 10:20 am</h3>
            <img src="route1.PNG" class="img-responsive" width="100%">
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Andrea, 5 star</h3>
            <h3>Departure: 9:50 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Adam, 5 star</h3>
            <h3>Departure: 10:00 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Steve, 4 star</h3>
            <h3>Departure: 10:20 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Steve, 4 star</h3>
            <h3>Departure: 9:50 am</h3>
            <img src="route2.PNG" class="img-responsive" width="100%">
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Adam, 5 star</h3>
            <h3>Departure: 10:00 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Steve, 4 star</h3>
            <h3>Departure: 10:20 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Steve, 4 star</h3>
            <h3>Departure: 9:50 am</h3>
            <iframe frameborder="0" style="border:0" src="loading.gif" allowfullscreen></iframe>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="mr-2">
            <h3>Driver: Adam, 5 star</h3>
            <h3>Departure: 10:00 am</h3>
            <img src="route3.PNG" class="img-responsive" width="100%">
          </div>
        </div>
      </div>
    </div>
      <script>
        $(function()  {
          console.log('init');
          var socket = io();
          socket.emit('getMapsFromServer');
          socket.on('sendMapsToClient', function(maps){
            i=0;
            $('iframe').each(function(){
              $(this).attr('src', maps[i]);
              i++;
            })
          });
        });

        var map = null;

        function switchSelectedRole(id) {
          const imgPassenger = document.getElementById('imgPassenger');
          const imgDriver = document.getElementById('imgDriver');
          const groupSize = document.getElementById('group-size');
          const driverFormElements = document.getElementById('driver-form-elements');
          if (id === 'imgPassenger' && (groupSize.style.display === "none" || groupSize.style.display === "")) {
            groupSize.style.display = "table";
            driverFormElements.style.display = "none";
            imgPassenger.style.backgroundColor = "mediumseagreen";
            imgDriver.style.backgroundColor = "lightskyblue";
          }
          else if (id === 'imgDriver' && (driverFormElements.style.display === "none" || driverFormElements.style.display === "")) {
            driverFormElements.style.display = "table";
            groupSize.style.display = "none";
            imgPassenger.style.backgroundColor = "lightskyblue";
            imgDriver.style.backgroundColor = "mediumseagreen";
          }
        }


        // This example requires the Places library. Include the libraries=places
        // parameter when you first load the API. For example:
        // <script
        // src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

        function initMap() {
          const mapOptions = {
            mapTypeControl: false,
            //center: {lat: -33.8688, lng: 151.2195}, instead center on calgary
            center: {lat: 51.047073, lng: -114.069243},
            zoom: 13
          };
          map = new google.maps.Map(document.getElementById("map"), mapOptions);

          new AutocompleteDirectionsHandler(map);
        }

        $('#newRideModal').on('shown.bs.modal', function () {
          initMap();
        });

        $("#newRideModal").on("shown.bs.modal", function(e) {
          google.maps.event.trigger(map, "resize");
        });

        /**
         * @constructor
         */
        function AutocompleteDirectionsHandler(map) {
          var newRideModal = document.getElementById('newRideModal');
          this.map = map;
          this.originPlaceId = null;
          this.destinationPlaceId = null;
          this.travelMode = 'DRIVING';
          this.directionsService = new google.maps.DirectionsService;
          this.directionsDisplay = new google.maps.DirectionsRenderer;
          this.directionsDisplay.setMap(map);

          var rideDetails = document.getElementById('ride-details');
          var originInput = document.getElementById('origin-input');
          var destinationInput = document.getElementById('destination-input');
          var modeSelector = document.getElementById('mode-selector');

          var originAutocomplete = new google.maps.places.Autocomplete(originInput);
          // Specify just the place data fields that you need.
          originAutocomplete.setFields(['place_id']);

          var destinationAutocomplete =
                  new google.maps.places.Autocomplete(destinationInput);
          // Specify just the place data fields that you need.
          destinationAutocomplete.setFields(['place_id']);

          // Commented out to force driving directions
          // this.setupClickListener('changemode-walking', 'WALKING');
          // this.setupClickListener('changemode-transit', 'TRANSIT');
          this.setupClickListener('changemode-driving', 'DRIVING');

          this.setupPlaceChangedListener(originAutocomplete, 'ORIG');
          this.setupPlaceChangedListener(destinationAutocomplete, 'DEST');

          this.rideDetails.push(originInput);
          this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(originInput);
          this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(
                  destinationInput);
          //this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(modeSelector);
        }

        // Sets a listener on a radio button to change the filter type on Places
        // Autocomplete.
        AutocompleteDirectionsHandler.prototype.setupClickListener = function (
                id, mode) {
          var radioButton = document.getElementById(id);
          var me = this;

          radioButton.addEventListener('click', function () {
            me.travelMode = mode;
            me.route();
          });
        };

        AutocompleteDirectionsHandler.prototype.setupPlaceChangedListener = function (
                autocomplete, mode) {
          var me = this;
          autocomplete.bindTo('bounds', this.map);

          autocomplete.addListener('place_changed', function () {
            var place = autocomplete.getPlace();

            if (!place.place_id) {
              window.alert('Please select an option from the dropdown list.');
              return;
            }
            if (mode === 'ORIG') {
              me.originPlaceId = place.place_id;
            } else {
              me.destinationPlaceId = place.place_id;
            }
            me.route();
          });
        };

        AutocompleteDirectionsHandler.prototype.route = function () {
          if (!this.originPlaceId || !this.destinationPlaceId) {
            return;
          }
          var me = this;
          var directionsObj = {
            //The ObjectID here will allow us to make sure we can have a unique identifier to remove/edit these objects if need be
            //Only will work if we allow 1 of every route? Otherwise we will need a different system.
            //objectID: this.originPlaceId + this.destinationPlaceId,
            origin: {'placeId': this.originPlaceId},
            destination: {'placeId': this.destinationPlaceId},
            travelMode: this.travelMode
          };

          this.directionsService.route(
                  directionsObj,
                  function (response, status) {
                    console.log(JSON.stringify(directionsObj.origin) + " " + JSON.stringify(directionsObj.destination) + " " + directionsObj.travelMode);
                    //Here we want to send this object back to server in order for the server to save this route for later
                    var socket = io();
                    socket.emit("sendNewMapToServer", directionsObj);

                    if (status === 'OK') {
                      me.directionsDisplay.setDirections(response);
                    } else {
                      window.alert('Directions request failed due to ' + status);
                    }

                    $(function () {
                      console.log("init");
                      socket.on("sendEmbeddedMap", function (embeddedMapString) {
                        console.log("Embedded map received: " + embeddedMapString);
                        document.getElementById('embeddedMap').src = embeddedMapString;
                      });
                    });

                  })
        };

      </script>
  </body>
</html>
